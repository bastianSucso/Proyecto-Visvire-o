<div class="min-h-[calc(100vh-64px)] bg-slate-50">
  <div class="mx-auto max-w-6xl px-4 py-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold text-slate-900">Ingreso de Inventario</h1>
        <div class="mt-1 text-sm text-slate-500">
          Registro por lote con lectura rápida de productos.
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          type="button"
          class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
          (click)="volver()"
        >
          Volver
        </button>

        <button
          type="button"
          class="rounded-xl bg-blue-700 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-800 disabled:opacity-50"
          (click)="confirmar()"
          [disabled]="items.length === 0 || loading"
        >
          Confirmar ingreso
        </button>
      </div>
    </div>
  </div>

  <div class="mx-auto max-w-6xl px-4 pb-28">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white">
        <div class="border-b border-slate-200 px-4 py-3">
          <h2 class="text-sm font-semibold text-slate-900">Productos del ingreso</h2>
          <p class="text-xs text-slate-500 mt-0.5">Items agregados al lote.</p>
        </div>

        <div class="px-4 py-3">
          <div *ngIf="items.length === 0" class="text-sm text-slate-500 py-6 text-center">
            No hay productos agregados todavía.
          </div>

          <div *ngIf="items.length > 0" class="overflow-auto">
            <table class="w-full text-left">
              <thead class="text-xs text-slate-500">
                <tr class="border-b border-slate-100">
                  <th class="py-2 pr-3">Producto</th>
                  <th class="py-2 pr-3">Unidad base</th>
                  <th class="py-2 pr-3 w-32 text-center">Cant.</th>
                  <th class="py-2 w-12"></th>
                </tr>
              </thead>

              <tbody class="text-sm">
                <tr *ngFor="let it of items" class="border-b border-slate-100 last:border-b-0">
                  <td class="py-3 pr-3">
                    <div class="font-medium text-slate-900 leading-5">
                      {{ it.name }}
                    </div>
                    <div class="text-xs text-slate-500 mt-0.5">
                      {{ it.internalCode }}
                      <span *ngIf="it.barcode">• {{ it.barcode }}</span>
                    </div>
                  </td>

                  <td class="py-3 pr-3 text-slate-600">
                    {{ it.unidadBase ?? '-' }}
                  </td>

                  <td class="py-3 pr-4">
                    <div class="flex items-center justify-center">
                      <input
                        type="number"
                        min="0.001"
                        step="0.001"
                        class="w-20 rounded-lg border border-slate-200 bg-white px-2 py-1.5 text-sm text-slate-900 text-center
                              focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:bg-slate-50"
                        [(ngModel)]="editCantidad[it.id]"
                        [disabled]="loading"
                        (blur)="guardarCantidad(it.id)"
                      />
                    </div>
                  </td>

                  <td class="py-3 text-right">
                    <button
                      type="button"
                      class="rounded-lg px-2 py-2 text-slate-400 hover:text-red-600 disabled:opacity-40"
                      [disabled]="loading"
                      (click)="eliminarItem(it.id)"
                      title="Eliminar"
                    >
                      ✕
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="scanError" class="mt-3 text-sm text-red-600">
            {{ scanError }}
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-white">
        <div class="border-b border-slate-200 px-4 py-3">
          <h2 class="text-sm font-semibold text-slate-900">Cabecera</h2>
          <p class="text-xs text-slate-500 mt-0.5">Destino y estado del ingreso.</p>
        </div>

        <div class="px-4 py-4 space-y-4">
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1">Destino</label>
            <select
              [(ngModel)]="destinoId"
              (ngModelChange)="onDestinoChange()"
              class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm"
            >
              <option value="">Selecciona ubicación</option>
              <option *ngFor="let u of ubicaciones" [ngValue]="u.id">
                {{ u.nombre }} ({{ u.tipo }})
              </option>
            </select>
            <p *ngIf="isDestinoSala" class="mt-2 text-xs text-amber-700">
              Estás ingresando directamente a la sala de ventas.
            </p>
          </div>

          <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
            <p class="text-xs text-slate-500">Documento</p>
            <p class="text-sm font-semibold text-slate-900 mt-1">
            {{ 'Pendiente' }}
          </p>
          <p class="text-xs text-slate-500 mt-1">
            Estado: <span class="font-medium text-slate-700">Por confirmar</span>
          </p>
        </div>

          <div *ngIf="errorMsg" class="text-sm text-red-600">
            {{ errorMsg }}
          </div>
          <div *ngIf="successMsg" class="text-sm text-emerald-700">
            {{ successMsg }}
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <div class="rounded-xl border border-slate-200 bg-white p-4">
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Buscar / Escanear producto
        </label>

        <div class="relative">
          <input
            #scanInput
            type="text"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm
                  text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-200
                  disabled:bg-slate-50"
            [ngModel]="scan"
            (ngModelChange)="onScanChange($event)"
            (keydown)="onScanKeydown($event)"
            (keyup.enter)="onScanEnter()"
            placeholder="Código de barras, código interno o nombre (Enter agrega)"
            autocomplete="off"
          />

          <div
            *ngIf="showSug"
            class="absolute z-50 mt-2 w-full rounded-xl border border-slate-200 bg-white shadow-sm
                  overflow-hidden max-h-60 overflow-auto"
          >
            <button
              type="button"
              *ngFor="let p of sugerencias; let i = index"
              (mousedown)="$event.preventDefault()"
              (mouseenter)="activeSugIndex = i"
              (click)="seleccionarSug(p)"
              class="w-full px-3 py-2 text-left flex items-center justify-between
                    transition focus:outline-none"
              [ngClass]="
                i === activeSugIndex
                  ? 'bg-blue-50 border-l-4 border-blue-600 ring-2 ring-blue-200'
                  : 'bg-white hover:bg-slate-50 border-l-4 border-transparent'
              "
            >
              <div class="min-w-0">
                <p class="text-sm font-semibold text-slate-900 truncate">
                  {{ p.name }}
                </p>
                <p class="text-xs text-slate-500 truncate">
                  {{ p.internalCode }}
                  <span *ngIf="p.barcode">• {{ p.barcode }}</span>
                  <span *ngIf="p.unidadBase" class="ml-1 inline-flex items-center rounded-full bg-slate-100 px-1.5 py-0.5 text-[10px] font-semibold text-slate-600">
                    {{ p.unidadBase }}
                  </span>
                    <span
                      *ngIf="p.tipo"
                      class="ml-1 inline-flex items-center rounded-full px-1.5 py-0.5 text-[10px] font-semibold ring-1"
                      [ngClass]="getTipoBadgeClass(p)"
                    >
                      {{ p.tipo }}
                    </span>
                </p>
              </div>
            </button>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <label class="text-xs text-slate-600">Cantidad rápida</label>
          <input
            type="number"
            min="1"
            class="w-24 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm"
            [(ngModel)]="cantidadRapida"
          />
        </div>

        <p class="mt-2 text-xs text-slate-500">
          Enter agrega automáticamente · Escáner compatible
        </p>
      </div>
    </div>
  </div>
</div>
