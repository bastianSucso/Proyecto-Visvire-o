<div class="min-h-[calc(100vh-64px)] bg-white">
  <div class="mx-auto w-full max-w-6xl px-4 py-6">
    <!-- Header -->
    <div class="mb-6 flex flex-wrap items-start justify-between gap-3">
      <div>
        <h1 class="text-xl font-semibold text-slate-900">Productos e insumos</h1>
        <p class="mt-1 text-sm text-slate-500">
          Registro y administración de productos e insumos con precio y stock.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <button
          type="button"
          (click)="load()"
          class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 active:bg-slate-100"
        >
          Refrescar
        </button>

        <button
          type="button"
          (click)="openCreate()"
          class="inline-flex items-center justify-center rounded-xl bg-blue-700 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-800 active:bg-blue-900"
        >
          + Nuevo producto o insumo
        </button>
      </div>
    </div>

    <!-- Error -->
    <div
      *ngIf="errorMsg"
      class="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
    >
      {{ errorMsg }}
    </div>

    <!-- Card -->
    <div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="p-5 sm:p-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-sm font-semibold text-slate-900">Listado</p>
            <p class="text-xs text-slate-500">
              Catálogo administrativo (solo ADMIN). El POS consume una vista operativa separada.
            </p>
          </div>

          <!-- Loading -->
          <div *ngIf="loading" class="flex items-center gap-3 text-sm text-slate-600">
            <div class="h-4 w-4 animate-spin rounded-full border-2 border-slate-200 border-t-slate-700"></div>
            Cargando productos...
          </div>
        </div>

        <!-- Toolbar (buscador + filas) -->
        <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex w-full flex-col gap-3 sm:max-w-2xl sm:flex-row">
            <input
              [(ngModel)]="q"
              (ngModelChange)="onSearchChange()"
              type="text"
              placeholder="Buscar por nombre / código / barcode..."
              class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
            />
            <select
              [(ngModel)]="tipoFilter"
              (change)="onTipoFilterChange()"
              class="w-full sm:w-52 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
            >
              <option value="ALL">Todos los tipos</option>
              <option value="INSUMO">Insumo</option>
              <option value="REVENTA">Reventa</option>
            </select>
          </div>

          <div class="flex items-center justify-between gap-3 sm:justify-end">
            <div class="text-xs text-slate-500">
              Mostrando {{ fromItem }} - {{ toItem }} de {{ totalItems }}
            </div>

            <div class="flex items-center gap-2">
              <label class="text-xs text-slate-500">Filas:</label>
              <select
                [(ngModel)]="pageSize"
                (change)="onPageSizeChange()"
                class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
              >
                <option *ngFor="let n of pageSizes" [ngValue]="n">{{ n }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tabla -->
        <div class="mt-4 overflow-x-auto rounded-xl border border-slate-200">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-4 py-3">Producto</th>
                <th class="px-4 py-3">Código</th>
                <th class="px-4 py-3">Barcode</th>
                <th class="px-4 py-3">Unidad</th>
                <th class="px-4 py-3">Tipo</th>
                <th class="px-4 py-3">Costo</th>
                <th class="px-4 py-3">Venta</th>
                <th class="px-4 py-3 text-center">Ganancia</th>
                <th class="px-4 py-3">Stock</th>
                <th class="px-4 py-3">Estado</th>
                <th class="px-4 py-3 text-right">Acciones</th>
              </tr>
            </thead>

            <tbody class="text-slate-800">
              <tr *ngFor="let p of pageItems" class="border-t border-slate-100">
                <td class="px-4 py-3 font-medium text-slate-900">{{ p.name }}</td>
                <td class="px-4 py-3 text-slate-600">{{ p.internalCode }}</td>
                <td class="px-4 py-3 text-slate-600">{{ p.barcode ?? '-' }}</td>
                <td class="px-4 py-3 text-slate-600">{{ p.unidadBase ?? '-' }}</td>

                <td class="px-4 py-3">
                  <span
                    class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1"
                    [ngClass]="{
                      'bg-blue-50 text-blue-700 ring-blue-200': (p.tipos?.[0] ?? '') === 'INSUMO',
                      'bg-emerald-50 text-emerald-700 ring-emerald-200': (p.tipos?.[0] ?? '') === 'REVENTA',
                      'bg-slate-100 text-slate-700 ring-slate-200': !(p.tipos?.[0])
                    }"
                  >
                    {{ p.tipos?.[0] ?? 'SIN TIPO' }}
                  </span>
                </td>

                <td class="px-4 py-3">
                  {{ +p.precioCosto | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </td>

                <td class="px-4 py-3">
                  {{ +p.precioVenta | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </td>

                <td class="px-4 py-3">
                  <div class="flex justify-center">
                    <ng-container *ngIf="(p.tipos?.[0] ?? '') !== 'INSUMO'; else sinGanancia">
                      <span
                        class="inline-flex min-w-[92px] justify-center rounded-full px-3 py-1 text-xs font-semibold ring-1"
                        [ngClass]="{
                          'bg-emerald-50 text-emerald-700 ring-emerald-200': (+p.precioVenta - +p.precioCosto) > 0,
                          'bg-rose-50 text-rose-700 ring-rose-200': (+p.precioVenta - +p.precioCosto) < 0,
                          'bg-slate-100 text-slate-700 ring-slate-200': (+p.precioVenta - +p.precioCosto) === 0
                        }"
                      >
                        {{ (+p.precioVenta - +p.precioCosto) | currency:'CLP':'symbol-narrow':'1.0-0' }}
                      </span>
                    </ng-container>
                    <ng-template #sinGanancia>
                      <span class="inline-flex min-w-[92px] justify-center rounded-full px-3 py-1 text-xs font-semibold ring-1 bg-slate-100 text-slate-700 ring-slate-200">
                        No Vendible
                      </span>
                    </ng-template>
                  </div>
                </td>

                <!-- Stock proporcionado y bonito -->
                <td class="px-4 py-3">
                  <span
                    class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium"
                    [ngClass]="{
                      'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200': (p.cantidadTotal ?? 0) > 0,
                      'bg-amber-50 text-amber-700 ring-1 ring-amber-200': p.cantidadTotal === 0
                    }"
                  >
                    {{ p.cantidadTotal }}
                  </span>
                </td>

                <td class="px-4 py-3">
                  <span
                    class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ring-1"
                    [ngClass]="{
                      'bg-emerald-50 text-emerald-700 ring-emerald-200': p.isActive,
                      'bg-slate-100 text-slate-700 ring-slate-200': !p.isActive
                    }"
                  >
                    {{ p.isActive ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>

                <!-- Acciones alineadas a la derecha -->
                <td class="px-4 py-3">
                  <div class="flex justify-end gap-2">
                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 active:bg-slate-100"
                      (click)="openEdit(p)"
                    >
                      Editar
                    </button>

                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 active:bg-slate-100"
                      (click)="toggleActive(p)"
                    >
                      {{ p.isActive ? 'Desactivar' : 'Activar' }}
                    </button>

                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-xl border border-red-200 bg-white px-3 py-2 text-xs font-semibold text-red-700 hover:bg-red-50 active:bg-red-100"
                      (click)="remove(p)"
                    >
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>

              <tr *ngIf="!loading && pageItems.length === 0">
                <td class="px-4 py-6 text-slate-500" colspan="11">
                  No hay resultados para la búsqueda.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación (como POS) -->
        <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div class="text-xs text-slate-500">
            Página {{ page }} / {{ totalPages }}
          </div>

          <div class="flex items-center justify-end gap-2">
            <button
              type="button"
              (click)="first()"
              [disabled]="page === 1"
              class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 bg-white text-sm font-semibold text-slate-700 disabled:opacity-50"
            >
              «
            </button>

            <button
              type="button"
              (click)="prev()"
              [disabled]="page === 1"
              class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-50"
            >
              Anterior
            </button>

            <button
              type="button"
              (click)="next()"
              [disabled]="page === totalPages"
              class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 disabled:opacity-50"
            >
              Siguiente
            </button>

            <button
              type="button"
              (click)="last()"
              [disabled]="page === totalPages"
              class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 bg-white text-sm font-semibold text-slate-700 disabled:opacity-50"
            >
              »
            </button>
          </div>
        </div>

        <!-- Nota -->
        <p class="mt-3 text-xs text-slate-500">
          Nota: La lista operativa (POS) se consume desde un endpoint separado, sin exposición del CRUD administrativo.
        </p>
      </div>
    </div>

    <!-- Modal (dejo el tuyo igual, pero con estilo ya consistente) -->
    <div *ngIf="isModalOpen" class="fixed inset-0 z-50 bg-black/30 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl bg-white border border-slate-200 shadow-xl">
        <div class="p-5 border-b border-slate-200 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900">
            {{ editing ? 'Editar producto' : 'Nuevo producto' }}
          </h2>
          <button class="text-slate-500 hover:text-slate-700" (click)="closeModal()">✕</button>
        </div>

        <form class="p-5 space-y-4" [formGroup]="form" (ngSubmit)="save()">
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Nombre</label>
              <input
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                formControlName="name"
              />
              <p *ngIf="c('name')?.touched && c('name')?.hasError('required')" class="mt-1 text-xs text-red-600">
                El nombre es obligatorio.
              </p>
            </div>

            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Código interno</label>
              <input
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                formControlName="internalCode"
              />
              <p *ngIf="c('internalCode')?.touched && c('internalCode')?.hasError('required')" class="mt-1 text-xs text-red-600">
                El código interno es obligatorio.
              </p>
            </div>

            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Código de barra (opcional)</label>
              <input
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                formControlName="barcode"
              />
            </div>

            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Precio costo</label>
              <input
                type="number"
                min="0"
                step="0.01"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                formControlName="precioCosto"
              />
            </div>

            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Precio venta</label>
                <input
                  type="number"
                  min="0"
                  step="0.01"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100 disabled:bg-slate-50 disabled:text-slate-500 disabled:cursor-not-allowed disabled:focus:ring-0 disabled:focus:border-slate-200"
                  formControlName="precioVenta"
                />
            </div>

            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Unidad base (opcional)</label>
              <select
                formControlName="unidadBase"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
              >
                <option value="">-- Selecciona unidad --</option>
                <option *ngFor="let u of unidadBaseOptions" [value]="u">{{ u }}</option>
              </select>
            </div>

            <div>
              <label class="mb-2 block text-sm font-medium text-slate-700">Tipos</label>
              <div class="flex flex-wrap gap-3">
                <label *ngFor="let t of tiposOptions" class="inline-flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-200"
                    [checked]="isTipoSelected(t)"
                    (change)="toggleTipo(t, $any($event.target).checked)"
                  />
                  <span>{{ t }}</span>
                </label>
              </div>
              <p *ngIf="c('tipos')?.touched && c('tipos')?.hasError('required')" class="mt-1 text-xs text-red-600">
                Debes seleccionar un tipo.
              </p>
            </div>
          </div>

          <div class="flex items-center justify-end gap-2 pt-2">
            <button
              type="button"
              class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50 active:bg-slate-100"
              (click)="closeModal()"
            >
              Cancelar
            </button>

            <button
              type="submit"
              class="rounded-xl bg-blue-700 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-800 active:bg-blue-900"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
