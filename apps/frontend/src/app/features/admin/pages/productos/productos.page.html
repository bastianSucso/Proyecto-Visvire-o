<div class="p-6 max-w-7xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-slate-900">Productos</h1>
      <p class="text-slate-500">Registro y administración de productos y precios.</p>
    </div>

    <button
      class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition"
      (click)="openCreate()"
    >
      + Nuevo producto
    </button>
  </div>

  <div *ngIf="errorMsg" class="mb-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-700">
    {{ errorMsg }}
  </div>

  <div class="rounded-xl border border-slate-200 bg-white overflow-hidden">
    <div class="p-4 border-b border-slate-200 flex items-center justify-between">
      <span class="text-slate-700 font-medium">Listado</span>
      <span *ngIf="loading" class="text-slate-400 text-sm">Cargando...</span>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead class="bg-slate-50 text-slate-600 text-sm">
          <tr>
            <th class="px-4 py-3">Nombre</th>
            <th class="px-4 py-3">Cód. interno</th>
            <th class="px-4 py-3">Barcode</th>
            <th class="px-4 py-3">Unidad</th>
            <th class="px-4 py-3">Precio costo</th>
            <th class="px-4 py-3">Precio venta</th>
            <th class="px-4 py-3">Ganancia</th>
            <th class="px-4 py-3">Stock total</th>
            <th class="px-4 py-3">Estado</th>
            <th class="px-4 py-3 w-52">Acciones</th>
          </tr>
        </thead>

        <tbody class="text-slate-800">
          <tr *ngFor="let p of productos" class="border-t border-slate-100">
            <td class="px-4 py-3 font-medium">{{ p.name }}</td>
            <td class="px-4 py-3 text-slate-600">{{ p.internalCode }}</td>
            <td class="px-4 py-3 text-slate-600">{{ p.barcode ?? '-' }}</td>
            <td class="px-4 py-3 text-slate-600">{{ p.unidadBase ?? '-' }}</td>
            <td class="px-4 py-3">{{ +p.precioCosto | currency:'CLP':'symbol-narrow':'1.0-0' }}</td>
            <td class="px-4 py-3">{{ +p.precioVenta | currency:'CLP':'symbol-narrow':'1.0-0' }}</td>
            <td
              class="px-4 py-3 font-medium"
              [ngClass]="{
                'text-emerald-600': p.gananciaProducto > 0,
                'text-rose-600': p.gananciaProducto < 0,
                'text-slate-600': p.gananciaProducto === 0
              }"
            >
              {{ p.gananciaProducto | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </td>
            <td class="px-4 py-3">{{ p.cantidadTotal }}</td>

            <td class="px-4 py-3">
            <span class="inline-flex items-center gap-2">
              <span class="h-2 w-2 rounded-full" [class.bg-green-500]="p.isActive" [class.bg-red-500]="!p.isActive"></span>
              <span class="text-slate-700">{{ p.isActive ? 'Activo' : 'Inactivo' }}</span>
            </span>
            </td>

            <td class="px-4 py-3 flex gap-2">
              <button
                class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50"
                (click)="openEdit(p)"
              >
                Editar
              </button>

              <button
                class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50"
                (click)="toggleActive(p)"
              >
                {{ p.isActive ? 'Desactivar' : 'Activar' }}
              </button>

              <button
                class="px-3 py-1.5 rounded-lg border border-red-200 text-red-700 hover:bg-red-50"
                (click)="remove(p)"
              >
                Eliminar
              </button>
            </td>
          </tr>

          <tr *ngIf="!loading && productos.length === 0">
            <td class="px-4 py-6 text-slate-500" colspan="9">No hay productos registrados.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="isModalOpen" class="fixed inset-0 bg-black/30 flex items-center justify-center p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white border border-slate-200 shadow-xl">
      <div class="p-5 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900">
          {{ editing ? 'Editar producto' : 'Nuevo producto' }}
        </h2>
        <button class="text-slate-500 hover:text-slate-700" (click)="closeModal()">✕</button>
      </div>

      <form class="p-5 space-y-4" [formGroup]="form" (ngSubmit)="save()">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-slate-700 mb-1">Nombre</label>
            <input
              class="w-full px-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-200"
              formControlName="name"
            />
            <p *ngIf="c('name')?.touched && c('name')?.hasError('required')" class="text-sm text-red-600 mt-1">
              El nombre es obligatorio.
            </p>
          </div>

          <div>
            <label class="block text-sm text-slate-700 mb-1">Código interno</label>
            <input
              class="w-full px-3 py-2 rounded-lg border border-slate-200"
              formControlName="internalCode"
            />
            <p *ngIf="c('internalCode')?.touched && c('internalCode')?.hasError('required')" class="text-sm text-red-600 mt-1">
              El código interno es obligatorio.
            </p>
          </div>

          <div>
            <label class="block text-sm text-slate-700 mb-1">Código de barra (opcional)</label>
            <input class="w-full px-3 py-2 rounded-lg border border-slate-200" formControlName="barcode" />
          </div>

          <div>
            <label class="block text-sm text-slate-700 mb-1">Unidad base (opcional)</label>
            <input class="w-full px-3 py-2 rounded-lg border border-slate-200" formControlName="unidadBase" />
          </div>

          <div>
            <label class="block text-sm text-slate-700 mb-1">Precio costo</label>
            <input type="number" min="0" step="0.01" class="w-full px-3 py-2 rounded-lg border border-slate-200" formControlName="precioCosto" />
          </div>

          <div>
            <label class="block text-sm text-slate-700 mb-1">Precio venta</label>
            <input type="number" min="0" step="0.01" class="w-full px-3 py-2 rounded-lg border border-slate-200" formControlName="precioVenta" />
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button
            type="button"
            class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50"
            (click)="closeModal()"
          >
            Cancelar
          </button>

          <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
